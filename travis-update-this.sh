#!/usr/bin/env bash
set -e -u -o pipefail

cd $TRAVIS_BUILD_DIR

./build-wsl-root.sh |& tee wsl-build.log

git config user.name "Travis CI"
git config user.email "travis@rob.ot"

git add wsl-build.log
git add install.tar.gz

chmod 600 travis_key
eval `ssh-agent -s`

ssh-add travis_key

git commit -m "$(date -u -I): rootfs built via travis"

export GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"

git remote set-url --push origin git@github.com:greyltc/archlinux-bootstrapper.git

TAG="$(date -u -I)"
git tag --annotate --force --message="${TAG} generated by travis" "${TAG}" master
git push origin master --force --tags
