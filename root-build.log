set -o xtrace

#set -e -u -o pipefail

wget --continue -nv -e robots=off -r --no-parent -A 'archlinux-bootstrap-*' https://mirrors.edge.kernel.org/archlinux/iso/latest/
+wget --continue -nv -e robots=off -r --no-parent -A 'archlinux-bootstrap-*' https://mirrors.edge.kernel.org/archlinux/iso/latest/
2019-10-31 18:03:23 URL:https://mirrors.edge.kernel.org/archlinux/iso/latest/ [1146] -> "mirrors.edge.kernel.org/archlinux/iso/latest/index.html.tmp" [1]
2019-10-31 18:03:23 URL:https://mirrors.edge.kernel.org/archlinux/iso/latest/arch/ [385] -> "mirrors.edge.kernel.org/archlinux/iso/latest/arch/index.html.tmp" [1]
2019-10-31 18:03:52 URL:https://mirrors.edge.kernel.org/archlinux/iso/latest/archlinux-bootstrap-2019.10.01-x86_64.tar.gz [154472911/154472911] -> "mirrors.edge.kernel.org/archlinux/iso/latest/archlinux-bootstrap-2019.10.01-x86_64.tar.gz" [1]
2019-10-31 18:03:52 URL:https://mirrors.edge.kernel.org/archlinux/iso/latest/archlinux-bootstrap-2019.10.01-x86_64.tar.gz.sig [310/310] -> "mirrors.edge.kernel.org/archlinux/iso/latest/archlinux-bootstrap-2019.10.01-x86_64.tar.gz.sig" [1]
2019-10-31 18:03:53 URL:https://mirrors.edge.kernel.org/archlinux/iso/latest/arch/boot/ [850] -> "mirrors.edge.kernel.org/archlinux/iso/latest/arch/boot/index.html.tmp" [1]
2019-10-31 18:03:53 URL:https://mirrors.edge.kernel.org/archlinux/iso/latest/arch/x86_64/ [523] -> "mirrors.edge.kernel.org/archlinux/iso/latest/arch/x86_64/index.html.tmp" [1]
2019-10-31 18:03:53 URL:https://mirrors.edge.kernel.org/archlinux/iso/latest/arch/boot/x86_64/ [637] -> "mirrors.edge.kernel.org/archlinux/iso/latest/arch/boot/x86_64/index.html.tmp" [1]
FINISHED --2019-10-31 18:03:53--
Total wall clock time: 30s
Downloaded: 7 files, 147M in 30s (4.96 MB/s)
mkdir -p /tmp/rootwork
+mkdir -p /tmp/rootwork
cp mirrors.edge.kernel.org/archlinux/iso/latest/archlinux-bootstrap-* /tmp/rootwork/.
+cp mirrors.edge.kernel.org/archlinux/iso/latest/archlinux-bootstrap-2019.10.01-x86_64.tar.gz mirrors.edge.kernel.org/archlinux/iso/latest/archlinux-bootstrap-2019.10.01-x86_64.tar.gz.sig /tmp/rootwork/.
pushd /tmp/rootwork
+pushd /tmp/rootwork
/tmp/rootwork ~/build/greyltc/archlinux-bootstrapper

# verify .sig
gpg --no-default-keyring --keyring ./vendors.gpg --keyserver keyserver.ubuntu.com --recv-keys 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
+gpg --no-default-keyring --keyring ./vendors.gpg --keyserver keyserver.ubuntu.com --recv-keys 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: keybox './vendors.gpg' created
gpg: key 7F2D434B9741E8AC: 48 signatures not checked due to missing keys
gpg: key 7F2D434B9741E8AC: public key "Pierre Schmitz <pierre@archlinux.de>" imported
gpg: no ultimately trusted keys found
gpg: Total number processed: 1
gpg:               imported: 1
gpg --no-default-keyring --keyring ./vendors.gpg --list-keys --fingerprint --with-colons | sed -E -n -e 's/^fpr:::::::::([0-9A-F]+):$/\1:6:/p' | gpg --no-default-keyring --keyring ./vendors.gpg --import-ownertrust
+sed -E -n -e 's/^fpr:::::::::([0-9A-F]+):$/\1:6:/p'
+gpg --no-default-keyring --keyring ./vendors.gpg --import-ownertrust
+gpg --no-default-keyring --keyring ./vendors.gpg --list-keys --fingerprint --with-colons
gpg: inserting ownertrust of 6
gpg: inserting ownertrust of 6
gpg --no-default-keyring --keyring ./vendors.gpg --verify *.sig
+gpg --no-default-keyring --keyring ./vendors.gpg --verify archlinux-bootstrap-2019.10.01-x86_64.tar.gz.sig
gpg: assuming signed data in 'archlinux-bootstrap-2019.10.01-x86_64.tar.gz'
gpg: Signature made Tue 01 Oct 2019 03:46:41 PM UTC
gpg:                using RSA key 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   2  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 2u
gpg: Good signature from "Pierre Schmitz <pierre@archlinux.de>" [ultimate]
rm vendors.gpg* *.sig
+rm vendors.gpg vendors.gpg~ archlinux-bootstrap-2019.10.01-x86_64.tar.gz.sig

sudo tar xzf archlinux-bootstrap-*-x86_64.tar.gz
+sudo tar xzf archlinux-bootstrap-2019.10.01-x86_64.tar.gz
tar: Ignoring unknown extended header keyword 'LIBARCHIVE.xattr.security.capability'
tar: Ignoring unknown extended header keyword 'LIBARCHIVE.xattr.security.capability'

cat <<EOF > /tmp/setup-tasks.sh
touch poop
echo "poop touched!"
EOF
+cat
chmod +x /tmp/setup-tasks.sh
+chmod +x /tmp/setup-tasks.sh
sudo sh -c 'mv /tmp/setup-tasks.sh  /tmp/rootwork/root.x86_64/usr/bin/.'
+sudo sh -c 'mv /tmp/setup-tasks.sh  /tmp/rootwork/root.x86_64/usr/bin/.'

sudo /tmp/rootwork/root.x86_64/bin/arch-chroot /tmp/rootwork/root.x86_64/ setup-tasks.sh
+sudo /tmp/rootwork/root.x86_64/bin/arch-chroot /tmp/rootwork/root.x86_64/ setup-tasks.sh
==> WARNING: /tmp/rootwork/root.x86_64/ is not a mountpoint. This may have undesirable side effects.
/bin/sh: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
poop touched!
sudo rm /tmp/rootwork/root.x86_64/bin/setup-tasks.sh
+sudo rm /tmp/rootwork/root.x86_64/bin/setup-tasks.sh

sudo sh -c 'cd /tmp/rootwork/root.x86_64 && tar -zcf ../root.tar.gz *'
+sudo sh -c 'cd /tmp/rootwork/root.x86_64 && tar -zcf ../root.tar.gz *'

popd
+popd
~/build/greyltc/archlinux-bootstrapper

mv /tmp/rootwork/root.tar.gz .
+mv /tmp/rootwork/root.tar.gz .

sudo rm -rf /tmp/rootwork
+sudo rm -rf /tmp/rootwork
